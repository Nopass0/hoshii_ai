# История изменений проекта

## 2025-04-09 14:25
- Добавлена поддержка золота в игровых действиях с параметром `goldChange`
- Улучшено отображение информации о вариантах действий с показом времени и золота
- Исправлена проблема с неправильным отображением времени в тексте сцены
- Улучшен промпт для генерации сцен с подробными инструкциями

## 2025-04-09 13:59
- Исправлены синтаксические ошибки в функции `startDndGame`
- Добавлено отображение сцены после генерации нового состояния игры
- Правильно структурирован игровой цикл с корректной обработкой ошибок
- Оптимизирован код для стабильной работы игровой логики

## 2025-04-09 (вечер)
- Исправлены ошибки в коде игры, связанные с обработкой ответов API
- Реализована поддержка инвентаря и системы управления предметами
- Добавлена система учета времени в игре с автоматическим обновлением времени суток
- Улучшен интерфейс игры с отображением здоровья, времени, погоды и NPC
- Добавлена проверка состояния персонажа (здоровье) и завершение игры при гибели

## 2025-04-09 (утро)
- Внедрена поддержка структурированных ответов с использованием OpenRouter API
- Изменена модель по умолчанию на openai/gpt-4o для поддержки структурированных выходных данных
- Добавлены новые параметры для повышения стабильности API запросов
- Исправлены ошибки при обработке структурированных ответов

## 09.04.2025 12:55 - Реализация официального механизма Structured Outputs

### Улучшения в файле `ai.ts`:
- Добавлен параметр `response_format` для структурированных ответов согласно документации OpenRouter
- Изменена модель по умолчанию на `openai/gpt-4o`, которая имеет стабильную поддержку structured outputs
- Включен параметр `strict: true` для гарантии соответствия ответа схеме

## 09.04.2025 12:45 - Исправление ошибок взаимодействия с API

### Улучшения в файле `ai.ts`:
- Изменена модель по умолчанию с `google/gemini-2.5-pro-exp-03-25:free` на более стабильную `openai/gpt-3.5-turbo`
- Добавлены оптимальные параметры для структурированных ответов:
  - Ограничение числа токенов (max_tokens: 1024)
  - Снижение температуры до 0.5 для более предсказуемых ответов
  - Установлен таймаут 30 секунд
- Улучшена обработка ошибок API с подробным логированием
- Исправлены ошибки синтаксиса в функции `generateStructured`

## 09.04.2025 - Улучшение взаимодействия с AI

### Улучшения в файле `ai.ts`:
- Добавлен класс `RateLimiter` для управления квотами API
  - Реализован механизм очереди запросов
  - Добавлена логика повторных попыток при ошибках API
  - Добавлено соблюдение ограничений частоты запросов
- Улучшена функция `generateStructured`:
  - Добавлена интеграция с `rateLimiter`
  - Улучшена обработка JSON-ответов от модели
  - Добавлена надежная обработка ошибок с информативными сообщениями
  - Реализована логика повторных попыток в случае неудачи
- Улучшена функция `generateText`:
  - Добавлена поддержка инструментов (tools)
  - Интегрирована с системой обработки квот
- Добавлен простой логгер для отладки, управляемый переменной окружения `DEBUG`
- Добавлены интерфейсы для типизации инструментов и их вызовов

### Улучшения в файле `app.ts`:
- Обновлены вызовы функций генерации текста и структурированных ответов
- Улучшена обработка ошибок при взаимодействии с AI

### Улучшения в зависимостях:
- Добавлена библиотека для логирования
